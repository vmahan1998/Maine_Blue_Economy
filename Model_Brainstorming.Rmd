---
title: "Model Structure Brainstorming"
author: "Vanessa Quintana"
date: "`r Sys.Date()`"
output: html_document
---

# Brainstorming Model Inputs
- landings by pound and by value from 1950-2019 (overall abundance and economic value)
- lobster landings by county for pound and value (ties abundance to reginal economic importance)
- 

## Input Data

### DMR Landings for Species 1950-2019
```{r}
rm(list = ls())  # Clears all objects from the environment

# Load necessary libraries
library(tidyverse)
library(forecast)
library(ggplot2)
library(dplyr)
library(lubridate)
library(tidyr)
library(caret)
library(randomForest)
library(tseries)
library(Metrics)

# Load historical data (1950-2019)
landings <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/MaineDMR_Landings_Time_Series_Data_2025-03-10.csv",
                     stringsAsFactors = FALSE)

# Inspect data
head(landings)
str(landings)
summary(landings)

```

### Lobster Landings by County in pounds and value
```{r}
# Load historical data (1950-2019)
lobster_County <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/LobByCntyMoZone.csv",
                     stringsAsFactors = FALSE)

# Inspect data
head(lobster_County)
str(lobster_County)
summary(lobster_County)
```


### NOAA Tides and Currents Water Levels Monthly Eastport, Portland, Bar Harbor, Maine.
```{r}
# Load Historical Water Level Data

# Load Portland, ME Water Level Data
portland <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Portland_Historic_Water_Levels.csv",
                     stringsAsFactors = FALSE)

# Inspect data
head(portland)
str(portland)
summary(portland)

# Load Portland, ME Water Level Data
eastport <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Eastport_Historic_Water_Levels.csv",
                     stringsAsFactors = FALSE)

# Inspect data
head(eastport)
str(eastport)
summary(eastport)

# Load Portland, ME Water Level Data
barharbor <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Bar_Harbor_Historic_Water_Levels.csv",
                     stringsAsFactors = FALSE)

# Inspect data
head(barharbor)
str(barharbor)
summary(barharbor)

# Function to clean and process water level data
clean_water_levels <- function(df, station_name) {
  df <- df %>%
    mutate(Date = as.Date(Date, format="%Y/%m/%d"),
           Year = year(Date)) %>%
    select(Year, MSL..ft.) %>%
    rename(Mean_Sea_Level_ft = MSL..ft.) %>%
    group_by(Year) %>%
    summarize(Mean_Sea_Level_ft = mean(Mean_Sea_Level_ft, na.rm = TRUE)) %>%
    mutate(Station = station_name)
  
  return(df)
}

# Apply function to each station
portland_clean <- clean_water_levels(portland, "Portland")
eastport_clean <- clean_water_levels(eastport, "Eastport")
barharbor_clean <- clean_water_levels(barharbor, "Bar Harbor")

# Combine all stations
water_levels <- bind_rows(portland_clean, eastport_clean, barharbor_clean)

# Convert feet to meters (1 ft = 0.3048 m)
water_levels <- water_levels %>%
  mutate(Mean_Sea_Level_m = Mean_Sea_Level_ft * 0.3048)

# Preview cleaned water levels
head(water_levels)
```

### NOAA Oceanic Nino Index (ONI)
```{r}
# If the data is tab-separated, use:
enso_data <- read.table("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/NOAA_ONI.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)

# Convert to numeric
enso_data$Anomaly <- as.numeric(enso_data$ANOM)

# Categorize ENSO Phases
enso_data <- enso_data %>%
  mutate(ENSO_Phase = case_when(
    Anomaly > 0.5 ~ "El Niño",
    Anomaly < -0.5 ~ "La Niña",
    TRUE ~ "Neutral"
  ))

# Inspect data
head(enso_data)
str(enso_data)
summary(enso_data)

```

### NOAA Stock Assessment Data
```{r}
# Load Stock Assessment Data
stocks <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Assessment_TimeSeries_Data.csv",
                   stringsAsFactors = FALSE, 
                   check.names = TRUE, 
                   skip = 0)  # Load all rows initially

# Save original column names to extract species names
original_colnames <- colnames(stocks)

# Extract species names (before the first "..")
species_names <- sub("\\..*", "", original_colnames)

# Combine species names with row 1 and row 4 for new column names
new_colnames <- paste(species_names, stocks[3, ], stocks[6, ], sep = "_")

# Assign new column names
colnames(stocks) <- new_colnames

# Save the first column's name before removing it
year_colname <- colnames(stocks)[1]

# Remove the first column (year column temporarily)
stocks <- stocks[, -1]  

# Remove rows 1, 2, and 4 (including extra metadata rows)
stocks <- stocks[-c(1:7), ]

# Reassign the saved year column name to the first column
colnames(stocks)[1] <- year_colname

# Identify rows where all columns except the first are empty
stocks <- stocks[-c(1:20), ]

# Reset row indices
rownames(stocks) <- NULL

# Inspect data
colnames(stocks)
head(stocks, 10)
str(stocks)
summary(stocks)
```

### Monthly Mean Average Temperature
```{r}
# Load Temperature Data Weather.gov
temp <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Portland_Monthly_Avg_Temp.csv",
                   stringsAsFactors = FALSE, 
                   check.names = TRUE, 
                   skip = 0)  # Load all rows initially

# Inspect data
colnames(temp)
head(temp, 10)
str(temp)
summary(temp)

# Load Precipitation Data
precip <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/Portland_Monthly_Avg_Precipitation.csv",
                   stringsAsFactors = FALSE, 
                   check.names = TRUE, 
                   skip = 0)  # Load all rows initially

# Inspect data
colnames(precip)
head(precip, 10)
str(precip)
summary(precip)

```


## Preprocessing

### Sea- Level

```{r}
ggplot(water_levels, aes(x = Year, y = Mean_Sea_Level_m, color = Station)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +  # Linear trend
  labs(title = "Historical Mean Sea Level Trends in Maine",
       y = "Mean Sea Level (m)", x = "Year") +
  theme_minimal()

```
```{r}
# Fit linear regression model for each station
linear_models <- water_levels %>%
  group_by(Station) %>%
  do(model = lm(Mean_Sea_Level_m ~ Year, data = .))

# Extract slope (sea level rise rate) for each station
slopes <- linear_models %>%
  summarise(Station, Rate_m_per_year = coef(model)[2])

print(slopes)

```


### Landings and Value

```{r}
# Aggregate total landings per year for each species
landings_yearly <- landings %>%
  group_by(year, species) %>%
  summarize(Total_Weight_kg = sum(total_weight, na.rm = TRUE),
            Total_Value = sum(total_value, na.rm = TRUE)) %>%
  ungroup()  # Ensure no lingering groupings

# Inspect results
head(landings_yearly)

```

### Lobster Landings

```{r}
# Set the first row as row names
colnames(lobster_County) <- lobster_County[1, ]

# Remove the first row from the dataset
lobster_County <- lobster_County[-1, ]

# Reset row indices
rownames(lobster_County) <- NULL

# Inspect the cleaned dataset
head(lobster_County)

# Convert Year to integer
lobster_County$Year <- as.integer(lobster_County$Year)

# Convert Pounds and Value to numeric (removing any commas)
lobster_County <- lobster_County %>%
  mutate(
    Pounds = as.numeric(gsub(",", "", Pounds)), 
    Value = as.numeric(gsub(",", "", Value))
  )

# Now summarize by Year and County
lobster_summary <- lobster_County %>%
  group_by(Year, County) %>%
  summarize(
    Total_Pounds = sum(Pounds, na.rm = TRUE),
    Total_Value = sum(Value, na.rm = TRUE)
  )

# Inspect the results
head(lobster_summary)

colnames(landings_yearly)[colnames(landings_yearly) == "year"] <- "Year"
colnames(lobster_summary)[colnames(lobster_summary) == "Total_Pounds"] <- "Lobster_Pounds"
colnames(lobster_summary)[colnames(lobster_summary) == "Total_Value"] <- "Lobster_Value"

# Ensure Year is numeric in all datasets
landings_yearly$Year <- as.integer(landings_yearly$Year)
lobster_summary$Year <- as.integer(lobster_summary$Year)
water_levels$Year <- as.integer(water_levels$Year)

# Merge Landings Data with Lobster Data (preserving county information)
merged_data <- landings_yearly  %>%
  left_join(lobster_summary, by = "Year")

# Merge with sea level data (averaging across stations)
merged_data <- merged_data %>%
  left_join(water_levels %>%
              group_by(Year) %>%
              summarize(Mean_Sea_Level_m = mean(Mean_Sea_Level_m, na.rm = TRUE)),
            by = "Year")

# Preview the merged dataset
head(merged_data)

# Check for any missing values
summary(merged_data)

```

### ENSO Data

```{r}

# Ensure Year is an integer
enso_data$Year <- as.integer(enso_data$YR)

# Summarize by Year: Identify the dominant ENSO phase per year
dominant_enso <- enso_data %>%
  group_by(Year, ENSO_Phase) %>%
  summarise(Count = n(), .groups = "drop") %>%  # Count occurrences of each phase per year
  arrange(Year, desc(Count)) %>%  # Sort by Year and Count (descending)
  distinct(Year, .keep_all = TRUE) %>%  # Keep only the most frequent ENSO phase per year
  select(Year, ENSO_Phase)  # Keep only relevant columns

# Merge dominant ENSO phase with merged_data
merged_data <- merged_data %>%
  left_join(dominant_enso, by = "Year")

# Inspect results
head(merged_data)
```

### Temperature and Precipitation Data

```{r}
# Convert Year column
temp$Year <- as.integer(temp$Year)
precip$Year <- as.integer(precip$Year)

# Rename the 'Annual' column in the temperature dataset to 'Annual_Temp'
temp <- temp %>%
  rename(Annual_Temp = Annual)

# Rename the 'Annual' column in the precipitation dataset to 'Annual_Precip'
precip <- precip %>%
  rename(Annual_Precip = Annual)

# Merge temperature and precipitation data
merged_data <- merged_data %>%
  left_join(temp %>% select(Year, Annual_Temp), by = "Year") %>%
  left_join(precip %>% select(Year, Annual_Precip), by = "Year")

head(merged_data)
summary(merged_data)
```

## Forecast Results

### Sea-Level Rise Scenarios
```{r}
# Define forecast years (2025-2050)
future_years <- seq(2020, 2100, by = 1)

# Predict baseline sea levels (historical trend)
slr_model <- lm(Mean_Sea_Level_m ~ Year, data = merged_data)
baseline_sea_levels <- predict(slr_model, newdata = data.frame(Year = future_years))

# NASA SLR Scenarios
low_slr <- baseline_sea_levels + (0.1 * ((future_years - 2020) / (2100 - 2020))^2)  # ~0.1m by 2100
moderate_slr <- baseline_sea_levels + (0.2 * ((future_years - 2020) / (2100 - 2025))^2)  # ~0.2m by 2100
high_slr <- baseline_sea_levels + (0.5 * ((future_years - 2020) / (2100 - 2020))^2)  # ~0.5m by 2100
```

### Warming Scenarios
```{r}
# Generate warming scenarios (based on temperature trends)
temp_model <- lm(Annual_Temp ~ Year, data = merged_data)
baseline_temp <- predict(temp_model, newdata = data.frame(Year = future_years))
low_temp <- baseline_temp + 0.5  # Low warming
moderate_temp <- baseline_temp + 1.0  # Moderate warming
high_temp <- baseline_temp + 2.0  # High warming

```

### All Scenarios
```{r}
# Create scenario-specific datasets
future_scenarios <- list(
  "Baseline" = data.frame(Year = future_years, Mean_Sea_Level_m = baseline_sea_levels, Annual_Temp = baseline_temp),
  "SLR_Low" = data.frame(Year = future_years, Mean_Sea_Level_m = low_slr, Annual_Temp = baseline_temp),
  "SLR_Moderate" = data.frame(Year = future_years, Mean_Sea_Level_m = moderate_slr, Annual_Temp = baseline_temp),
  "SLR_High" = data.frame(Year = future_years, Mean_Sea_Level_m = high_slr, Annual_Temp = baseline_temp),
  "Temp_Low" = data.frame(Year = future_years, Mean_Sea_Level_m = baseline_sea_levels, Annual_Temp = low_temp),
  "Temp_Moderate" = data.frame(Year = future_years, Mean_Sea_Level_m = baseline_sea_levels, Annual_Temp = moderate_temp),
  "Temp_High" = data.frame(Year = future_years, Mean_Sea_Level_m = baseline_sea_levels, Annual_Temp = high_temp),
  "SLR_Temp_Low" = data.frame(Year = future_years, Mean_Sea_Level_m = low_slr, Annual_Temp = low_temp),
  "SLR_Temp_Moderate" = data.frame(Year = future_years, Mean_Sea_Level_m = moderate_slr, Annual_Temp = moderate_temp),
  "SLR_Temp_High" = data.frame(Year = future_years, Mean_Sea_Level_m = high_slr, Annual_Temp = high_temp)
)

```


### Predict Species Results

```{r}
species_list <- unique(merged_data$species)
species_forecasts <- list()

for (species_name in species_list) {
  cat("\nProcessing Species:", species_name, "\n")
  
  species_data <- merged_data %>%
    filter(species == species_name, Year <= 2019) %>%
    select(Year, Total_Weight_kg, Total_Value, Mean_Sea_Level_m, Annual_Temp, Annual_Precip) %>%
    arrange(Year)

  if (nrow(species_data) == 0) next  # Skip species with no data

  species_data <- species_data %>%
    mutate(across(c(Mean_Sea_Level_m, Annual_Temp, Annual_Precip), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

  ts_weight <- ts(species_data$Total_Weight_kg, start = min(species_data$Year), frequency = 1)
  ts_value <- ts(species_data$Total_Value, start = min(species_data$Year), frequency = 1)

  fit_weight <- auto.arima(ts_weight, xreg = cbind(species_data$Mean_Sea_Level_m, species_data$Annual_Temp), seasonal = TRUE)
  fit_value <- auto.arima(ts_value, xreg = cbind(species_data$Mean_Sea_Level_m, species_data$Annual_Temp), seasonal = TRUE)

  for (scenario_name in names(future_scenarios)) {
    scenario_data <- future_scenarios[[scenario_name]]
    forecast_weight <- forecast(fit_weight, xreg = cbind(scenario_data$Mean_Sea_Level_m, scenario_data$Annual_Temp), h = length(future_years))
    forecast_value <- forecast(fit_value, xreg = cbind(scenario_data$Mean_Sea_Level_m, scenario_data$Annual_Temp), h = length(future_years))

    species_forecasts[[paste(species_name, scenario_name, sep = "_")]] <- data.frame(
      Year = future_years,
      Scenario = scenario_name,
      species = species_name,
      Pred_Total_Weight_kg = forecast_weight$mean,
      Pred_Total_Value = forecast_value$mean
    )
  }
}

final_species_forecast <- bind_rows(species_forecasts)

# Plot Predictions
ggplot(final_species_forecast, aes(x = Year, y = Pred_Total_Weight_kg, color = species)) +
  geom_line() +
  labs(title = "Projected Landings by Species", x = "Year", y = "Total Weight (kg)")

ggplot(final_species_forecast, aes(x = Year, y = Pred_Total_Value, color = species)) +
  geom_line() +
  labs(title = "Projected Value by Species", x = "Year", y = "Total Value ($)")

```

### Predict Lobster Landings by County

```{r}
county_list <- unique(merged_data$County)
county_forecasts <- list()

for (county_name in county_list) {
  cat("\nProcessing County:", county_name, "\n")

  county_data <- merged_data %>%
    filter(County == county_name, Year <= 2019) %>%
    select(Year, Lobster_Pounds, Lobster_Value, Mean_Sea_Level_m, Annual_Temp, Annual_Precip) %>%
    arrange(Year)

  if (nrow(county_data) == 0) next  

  county_data <- county_data %>%
    mutate(across(c(Mean_Sea_Level_m, Annual_Temp, Annual_Precip), ~ ifelse(is.na(.), mean(., na.rm = TRUE), .)))

  ts_lobster_pounds <- ts(county_data$Lobster_Pounds, start = min(county_data$Year), frequency = 1)
  ts_lobster_value <- ts(county_data$Lobster_Value, start = min(county_data$Year), frequency = 1)

  fit_lobster_pounds <- auto.arima(ts_lobster_pounds, xreg = cbind(county_data$Mean_Sea_Level_m, county_data$Annual_Temp), seasonal = TRUE)
  fit_lobster_value <- auto.arima(ts_lobster_value, xreg = cbind(county_data$Mean_Sea_Level_m, county_data$Annual_Temp), seasonal = TRUE)

  for (scenario_name in names(future_scenarios)) {
    scenario_data <- future_scenarios[[scenario_name]]
    forecast_lobster_pounds <- forecast(fit_lobster_pounds, xreg = cbind(scenario_data$Mean_Sea_Level_m, scenario_data$Annual_Temp), h = length(future_years))
    forecast_lobster_value <- forecast(fit_lobster_value, xreg = cbind(scenario_data$Mean_Sea_Level_m, scenario_data$Annual_Temp), h = length(future_years))

    county_forecasts[[paste(county_name, scenario_name, sep = "_")]] <- data.frame(
      Year = future_years,
      Scenario = scenario_name,
      County = county_name,
      Pred_Lobster_Pounds = forecast_lobster_pounds$mean,
      Pred_Lobster_Value = forecast_lobster_value$mean
    )
  }
}

final_county_forecast <- bind_rows(county_forecasts)

# County Lobster Pounds
ggplot(final_county_forecast, aes(x = Year, y = Pred_Lobster_Pounds, color = County)) +
  geom_line() +
  labs(title = "Projected Lobster Landings by County", x = "Year", y = "Lobster Pounds")

# County Lobster Value
ggplot(final_county_forecast, aes(x = Year, y = Pred_Lobster_Value, color = County)) +
  geom_line() +
  labs(title = "Projected Lobster Value by County", x = "Year", y = "Lobster Value ($)")
```

## Validate Model

### Species

## Lobster by County
```{r}
lobster_validation <- read.csv("C:/Users/RDEL1VMM/Desktop/current projects/Maine_Blue_Economy/Available Data/LobByCntyMoZone_2020_2024.csv",
                   stringsAsFactors = FALSE, 
                   check.names = TRUE, 
                   skip = 0)  # Load all rows initially

# Set the first row as row names
colnames(lobster_validation) <- lobster_validation[1, ]

# Remove the first row from the dataset
lobster_validation <- lobster_validation[-1, ]

# Reset row indices
rownames(lobster_validation) <- NULL

# Convert Year column to numeric
lobster_validation$Year <- as.numeric(lobster_validation$Year)

# Convert numerical columns
lobster_validation$Lobster_Pounds <- as.numeric(lobster_validation$Pounds)
lobster_validation$Lobster_Value <- as.numeric(lobster_validation$Value)

# Merge forecasted data with actual validation data
comparison_data <- final_county_forecast %>%
  filter(Year >= 2020 & Year <= 2024) %>%
  left_join(lobster_validation, by = c("Year", "County"))

# Check if any rows still contain NA values
summary(comparison_data)

# Convert to long format for easier ggplot handling
comparison_pounds_long <- comparison_data %>%
  pivot_longer(cols = c(Pred_Lobster_Pounds, Lobster_Pounds), 
               names_to = "Type", values_to = "Lobster_Pounds") %>%
  mutate(Type = ifelse(Type == "Lobster_Pounds", "Observed", Scenario))

# Same for Lobster Value
comparison_value_long <- comparison_data %>%
  pivot_longer(cols = c(Pred_Lobster_Value, Lobster_Value), 
               names_to = "Type", values_to = "Lobster_Value") %>%
  mutate(Type = ifelse(Type == "Lobster_Value", "Observed", Scenario))

# Unique counties
counties <- unique(comparison_pounds_long$County)

for (county in counties) {
  
  county_data <- comparison_pounds_long %>% filter(County == county)
  county_value_data <- comparison_value_long %>% filter(County == county)

  # Assign colors and linetypes
  unique_types <- unique(county_data$Type)
  scenario_colors <- setNames(rainbow(length(unique_types)), unique_types) 
  scenario_linetypes <- setNames(rep("dashed", length(unique_types)), unique_types)

  # Ensure "Observed" is black and solid
  scenario_colors["Observed"] <- "black"
  scenario_linetypes["Observed"] <- "solid"

  # Plot Lobster Landings
  p1 <- ggplot(county_data, aes(x = Year, y = Lobster_Pounds, color = Type, linetype = Type)) +
    geom_line(size = 1, alpha = 0.7) +
    scale_color_manual(values = scenario_colors) +
    scale_linetype_manual(values = scenario_linetypes) +
    labs(title = paste("Lobster Landings in", county, "(2020-2024)"),
         x = "Year", y = "Lobster Pounds", color = "Scenario", linetype = "Scenario") +
    xlim(2020, 2024) +
    theme_minimal()

  print(p1)

  # Plot Lobster Value
  p2 <- ggplot(county_value_data, aes(x = Year, y = Lobster_Value, color = Type, linetype = Type)) +
    geom_line(size = 1, alpha = 0.7) +
    scale_color_manual(values = scenario_colors) +
    scale_linetype_manual(values = scenario_linetypes) +
    labs(title = paste("Lobster Value in", county, "(2020-2024)"),
         x = "Year", y = "Lobster Value ($)", color = "Scenario", linetype = "Scenario") +
    xlim(2020, 2024) +
    theme_minimal()

  print(p2)
}

# Compute error metrics for Lobster Pounds
mae_pounds <- mae(comparison_data$Lobster_Pounds, comparison_data$Pred_Lobster_Pounds)
mse_pounds <- mse(comparison_data$Lobster_Pounds, comparison_data$Pred_Lobster_Pounds)
rmse_pounds <- rmse(comparison_data$Lobster_Pounds, comparison_data$Pred_Lobster_Pounds)
r2_pounds <- cor(comparison_data$Lobster_Pounds, comparison_data$Pred_Lobster_Pounds, use = "complete.obs")^2

# Compute error metrics for Lobster Value
mae_value <- mae(comparison_data$Lobster_Value, comparison_data$Pred_Lobster_Value)
mse_value <- mse(comparison_data$Lobster_Value, comparison_data$Pred_Lobster_Value)
rmse_value <- rmse(comparison_data$Lobster_Value, comparison_data$Pred_Lobster_Value)
r2_value <- cor(comparison_data$Lobster_Value, comparison_data$Pred_Lobster_Value, use = "complete.obs")^2

# Print Error Metrics
cat("Lobster Pounds Prediction Evaluation:\n")
cat("MAE:", mae_pounds, "\n")
cat("MSE:", mse_pounds, "\n")
cat("RMSE:", rmse_pounds, "\n")
cat("R²:", r2_pounds, "\n\n")

cat("Lobster Value Prediction Evaluation:\n")
cat("MAE:", mae_value, "\n")
cat("MSE:", mse_value, "\n")
cat("RMSE:", rmse_value, "\n")
cat("R²:", r2_value, "\n")
```



